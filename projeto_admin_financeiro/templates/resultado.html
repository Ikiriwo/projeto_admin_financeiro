{% extends "base.html" %}
{% block content %}
<div class="card">
    <h2>Dados extra√≠dos da Nota Fiscal</h2>
    
    <!-- Abas para alternar entre visualiza√ß√µes -->
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('formatado')">Visualiza√ß√£o Formatada</button>
        <button class="tab-btn" onclick="showTab('json')">JSON</button>
    </div>
    
    <!-- Conte√∫do da aba formatada -->
    <div id="formatado" class="tab-content active">
        <div class="resultado">
            <p><strong>Fornecedor:</strong> {{ resultado['Fornecedor']['Razao Social'] }} - CNPJ: {{ resultado['Fornecedor']['CNPJ'] }}</p>
            <p><strong>Faturado:</strong> {{ resultado['Faturado']['Nome'] }} - CPF: {{ resultado['Faturado']['CPF'] }}</p>
            <p><strong>Nota Fiscal:</strong> {{ resultado['Nota Fiscal'] }}</p>
            <p><strong>Data de Emiss√£o:</strong> {{ resultado['Data Emissao'] }}</p>
            <p><strong>Produtos:</strong> {{ resultado['Descricao Produtos'] | join(", ") }}</p>
            <p><strong>Valor Total:</strong> R$ {{ "%.2f"|format(resultado['Valor Total']) }}</p>
            <p><strong>Classifica√ß√£o:</strong> {{ resultado['Classificacao_Despesa'] }}</p>
        </div>
    </div>
    
    <!-- Conte√∫do da aba JSON -->
    <div id="json" class="tab-content">
        <div class="json-container">
            <div class="json-header">
                <span>Dados em JSON</span>
                <button class="copy-btn" onclick="copyJson()">Copiar JSON</button>
            </div>
            <pre class="json-code">{{ resultado_json }}</pre>
            <p class="json-info">Este JSON cont√©m todos os dados extra√≠dos da nota fiscal e pode ser usado para integra√ß√£o com outros sistemas.</p>
        </div>
    </div>
    
    <!-- Feedback de valida√ß√£o autom√°tica -->
    <div>
        <span id="feedback-validacao" class="feedback-text"></span>
    </div>

    <!-- Se√ß√£o de Valida√ß√£o e Consulta -->
    <div id="validacao-section" class="card">
        <div class="card-header">
            <h3>Valida√ß√£o de Registros</h3>
        </div>
        <div class="card-body">
            <div class="painel-grid">
                <!-- Painel Fornecedor -->
                <div class="painel">
                    <div class="painel-header">
                        <span class="painel-title">üè¢ Fornecedor</span>
                        <span id="status-fornecedor" class="status-badge">Aguardando...</span>
                    </div>
                    <div class="painel-body">
                        <div class="campo"><strong>Raz√£o Social:</strong> {{ resultado['Fornecedor']['Razao Social'] }}</div>
                        <div class="campo"><strong>CNPJ:</strong> {{ resultado['Fornecedor']['CNPJ'] }}</div>
                        <div class="campo"><strong>ID:</strong> <span id="id-fornecedor">‚Äî</span></div>
                        <button id="btn-cadastrar-fornecedor" class="btn" style="display:none;">Cadastrar Novo</button>
                    </div>
                </div>

                <!-- Painel Faturado -->
                <div class="painel">
                    <div class="painel-header">
                        <span class="painel-title">üë§ Faturado</span>
                        <span id="status-faturado" class="status-badge">Aguardando...</span>
                    </div>
                    <div class="painel-body">
                        <div class="campo"><strong>Nome:</strong> {{ resultado['Faturado']['Nome'] }}</div>
                        <div class="campo"><strong>CPF:</strong> {{ resultado['Faturado']['CPF'] }}</div>
                        <div class="campo"><strong>ID:</strong> <span id="id-faturado">‚Äî</span></div>
                        <button id="btn-cadastrar-faturado" class="btn" style="display:none;">Cadastrar Novo</button>
                    </div>
                </div>

                <!-- Painel Classifica√ß√£o / Despesa -->
                <div class="painel">
                    <div class="painel-header">
                        <span class="painel-title">üí∞ Despesa</span>
                        <span id="status-classificacao" class="status-badge">Aguardando...</span>
                    </div>
                    <div class="painel-body">
                        <div class="campo"><strong>Classifica√ß√£o:</strong> {{ resultado['Classificacao_Despesa'] }}</div>
                        <div class="campo"><strong>ID:</strong> <span id="id-classificacao">‚Äî</span></div>
                        <button id="btn-cadastrar-classificacao" class="btn" style="display:none;">Cadastrar Novo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Se√ß√£o de Itens da Nota -->
    <div id="itens-section" class="card">
        <div class="card-header">
            <h3>Itens da Nota</h3>
        </div>
        <div class="card-body">
            <table class="table-itens">
                <thead>
                    <tr>
                        <th>Descri√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in resultado['Descricao Produtos'] %}
                    <tr>
                        <td>{{ item }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Resumo do Lan√ßamento -->
    <div id="resumo-section" class="card">
        <div class="card-header">
            <h3>Resumo do Lan√ßamento</h3>
        </div>
        <div class="card-body resumo-info">
            <p><strong>Fornecedor (ID):</strong> <span id="resumo-id-fornecedor">‚Äî</span></p>
            <p><strong>Faturado (ID):</strong> <span id="resumo-id-faturado">‚Äî</span></p>
            <p><strong>Classifica√ß√£o (ID):</strong> <span id="resumo-id-classificacao">‚Äî</span></p>
            <p><strong>Valor Total:</strong> R$ {{ "%.2f"|format(resultado['Valor Total']) }}</p>
            <p><strong>Data de Emiss√£o:</strong> {{ resultado['Data Emissao'] }}</p>
            <p><strong>Tipo:</strong> A PAGAR</p>
            <button id="btn-confirmar" class="btn-primary">‚úÖ Confirmar Lan√ßamento no Sistema</button>
            <span id="feedback-lancamento" class="feedback-text"></span>
        </div>
    </div>
    
    <script>
        // Dados extra√≠dos dispon√≠veis para o JS
        var dadosJSON = {{ resultado | tojson | safe }};
        window.dadosExtraidos = dadosJSON;

        // Valida√ß√£o autom√°tica ao carregar a p√°gina de resultados
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('validacao-section').style.display = 'block';
            document.getElementById('itens-section').style.display = 'block';
            document.getElementById('resumo-section').style.display = 'block';
            
            // Iniciar valida√ß√£o explicitamente
            if (typeof validarDados === 'function') {
                validarDados(window.dadosExtraidos);
            } else {
                console.error('Fun√ß√£o validarDados n√£o encontrada');
            }
        });
        document.getElementById('btn-cadastrar-fornecedor').addEventListener('click', function() {
            if (window.cadastrarFornecedor) {
                window.cadastrarFornecedor(window.dadosExtraidos);
            }
        });
        document.getElementById('btn-cadastrar-faturado').addEventListener('click', function() {
            if (window.cadastrarFaturado) {
                window.cadastrarFaturado(window.dadosExtraidos);
            }
        });
        document.getElementById('btn-cadastrar-classificacao').addEventListener('click', function() {
            if (window.cadastrarClassificacao) {
                window.cadastrarClassificacao(window.dadosExtraidos);
            }
        });
        document.getElementById('btn-confirmar').addEventListener('click', function() {
            if (window.confirmarLancamento) {
                window.confirmarLancamento(window.dadosExtraidos);
            }
        });
    </script>

    <a href="{{ url_for('index') }}" class="btn">Voltar</a>
</div>

<script>
    function showTab(tabId) {
        // Esconde todos os conte√∫dos de abas
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove a classe active de todos os bot√µes
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Mostra o conte√∫do da aba selecionada
        document.getElementById(tabId).classList.add('active');
        
        // Adiciona a classe active ao bot√£o clicado
        event.target.classList.add('active');
    }
    
    function copyJson() {
        const jsonText = document.querySelector('.json-code').textContent;
        navigator.clipboard.writeText(jsonText)
            .then(() => {
                alert('JSON copiado para a √°rea de transfer√™ncia!');
            })
            .catch(err => {
                console.error('Erro ao copiar: ', err);
            });
    }
</script>
{% endblock %}